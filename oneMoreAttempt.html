<!DOCTYPE html>
<html>
  <head>
    <title>Minimal Cartogram</title>
    <script src="libs/d3.v3.min.js"></script>
    <script src="libs/topojson.js"></script>
    <script src="cartogram.js"></script>
    <style type="text/css">

      path.state {
        stroke: #666;
        stroke-width: .5;
      }

      path.state:hover {
        stroke: #000;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <h1>Cartograms with d3 &amp; TopoJSON</h1>
      <form>
        <p>
          <label>Scale by <select id="field"></select></label>
          <label>in <select id="year"></select></label>
        </p>
      </form>
      <div id="map-container">
        <svg id="map"></svg>
      </div>
    </div>
    <script>

      // for scope, some variables
      var energydata, features;

      // hardcoded variables to replace with UI 
      var year = 1971, index = 25;

      // from other file, untouched 
      var map = d3.select("#map"),
          layer = map.append("g")
            .attr("id", "layer"),
          states = layer.append("g")
            .attr("id", "states")
            .selectAll("path");

      // variables including world view merc projection (the plane is the world, not just US)
      var proj = d3.geo.mercator(),
          topology,
          geometries,
          features,
          path,
          carto;
     
      // on click, this function is called
      window.onclick = function() {
        // toggle year data
        if (year == 2005)
          year = 1971;
        else
          year = 2005;

        update();
      };

      // read in the world conutry outline data
      d3.json("data/world_data.json", function(topo) {
        // store topo and gemoetires, if curious, console.log these and print them
        topology = topo;
        geometries = topology.objects.countries.geometries;

        // here is where the cartogram.js is called - compare and printout whatever
        carto = d3.cartogram()
            .projection(proj)
            // store the correct properties into the proper parties for carto
            .properties(function(d) {
              return geometries[d.id].properties;
            })
            // not sure if this does anything, but tried to imitate the originalCartogram code
            .value(function(d) {
              // make sure the value isn't undefined (no country) or the data isn't empty
              if (energydata[index].countries[d.properties.name] != undefined && energydata[index].countries[d.properties.name][year] != "" )
                return +energydata[index].countries[d.properties.name][year];
              else
                return 1;
            });

        // load the energy data
        d3.json("data/globalenergyuse-cleaned.json", function(error, data) {
          energydata = data;
          init();
        });
      });

      function init() {

        // create features, you can print out features to see what it's like
        features = carto.features(topology, geometries);
        //console.log(features)
            // draws the initial projection? from originalCode
        path = d3.geo.path()
              .projection(proj);

        // this udpates the features
        states = states.data(features)
          .enter()
          .append("path")
            .attr("class", "state")
            .attr("id", function(d) {
              return d.properties.name;
            })
            .attr("fill", "#ffffff")
            .attr("d", path);

        states.append("title");

        update();
      }


      function update() {
  
        // just some helpful printouts to show that the event is being handled
        console.log("updating")
        console.log("year is: ")
        console.log(year);

        // compute value by getting the right valid data 
        var value = function(d) {
          if (energydata[index].countries[d.properties.name] != undefined && energydata[index].countries[d.properties.name][year] != "" )
            return +energydata[index].countries[d.properties.name][year];
          else
            return 1;
        }

        // the min and max has been tested extensively - still printout quickly though to confirm, won't hurt
        // the map stores the values based on the function "value" into an array called "values"
        var values = states.data()
              .map(value) 
              .filter(function(n) {
                return !isNaN(n);
              })
              // sort ascending
              .sort(d3.ascending),

            // get min and max for the range - this is tested by Wesley
            low = values[0],
            high = values[values.length - 1];

        // linear color scale
        var color = d3.scale.category10();

        // normalize the data to the scale - 
        // maybe use log scale
        // var scale = d3.scale.log()
        var scale = d3.scale.log()
          .domain([low, high])
          // the smaller the range, the more distortion
          .range([1, 30]);

        // tell the cartogram to use the scaled values - I believe this updates the cartogram internal data
        carto.value(function(d) {
          //console.log(value(d))
          //return Math.random() * 100;
          return scale(value(d));
        });

        // generate the new features, pre-projected
        features = carto(topology, geometries).features;
        //console.log(features)

        // update the data on the map
        states.data(features)
          // update tooltips
          .select("title")
            .text(function(d) {
              // should reflect the change in data when clicked
              return [d.properties.name, value(d)].join(": ");
            });


        //console.log(states.data())
        // apply smooth transition
        states.transition()
          .duration(1)
          // change color, it's also transitioned - just for fun
          //.attr("fill", function(d) {
          //  return color(value(d));
          //})
          // this should be where the paths get updated - but currently I believe somehow  internally this isn't working - maybe write a function inside this and print out "d"?
          .attr("d", carto.path);
      }
    </script>
  </body>
</html>
